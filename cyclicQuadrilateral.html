<title>حساب مساحة الرباعي الدائري</title>

<div class="calc-container">
    <div class="card">
        <div class="input-group">
            <label><i class="fas fa-arrows-alt-h"></i> الضلع الأول (a)</label>
            <input type="number" id="a" placeholder="أدخل الطول بالمتر" step="any" oninput="calculateArea()">
        </div>
        <div class="input-group">
            <label><i class="fas fa-arrows-alt-h"></i> الضلع الثاني (b)</label>
            <input type="number" id="b" placeholder="أدخل الطول بالمتر" step="any" oninput="calculateArea()">
        </div>
        <div class="input-group">
            <label><i class="fas fa-arrows-alt-v"></i> الضلع الثالث (L1)</label>
            <input type="number" id="L1" placeholder="أدخل الطول بالمتر" step="any" oninput="calculateArea()">
        </div>
        <div class="input-group">
            <label><i class="fas fa-arrows-alt-v"></i> الضلع الرابع (L2)</label>
            <input type="number" id="L2" placeholder="أدخل الطول بالمتر" step="any" oninput="calculateArea()">
        </div>
    </div>

    <div id="drawing-container" class="card hidden" style="padding: 10px;">
        <h4 style="margin: 10px 0; color: var(--primary);">الرسم التوضيحي (براهماغوبتا):</h4>
        <div class="canvas-scroll-container" id="canvasScroll">
            <canvas id="shapeCanvas"></canvas>
        </div>
    </div>

    <div id="initialArea" class="result-card hidden">
        <!-- النتائج الأولية هتظهر هنا -->
    </div>

    <button class="btn-main" onclick="saveResult()" id="saveBtn" style="display: none; margin-top: 10px; background: #27ae60;">
        <i class="fas fa-save"></i> حفظ النتيجة
    </button>
</div>

<style>
    .calc-container {
        display: flex;
        flex-direction: column;
        gap: 15px;
        padding-bottom: 20px;
    }

    /* حاوية الرسمة عشان تكون قابلة للتمرير */
    .canvas-scroll-container {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin: 15px 0;
        padding: 5px;
        cursor: grab;
        background: rgba(0,0,0,0.02);
        border-radius: 16px;
    }

    .canvas-scroll-container:active {
        cursor: grabbing;
    }

    .dark-mode .canvas-scroll-container {
        background: rgba(255,255,255,0.02);
    }

    #shapeCanvas {
        display: block;
        margin: 0 auto;
        background: var(--card-light);
        border-radius: 16px;
        border: 1px solid var(--border-light);
    }

    .dark-mode #shapeCanvas {
        background: var(--card-dark);
        border: 1px solid var(--border-dark);
    }

    .input-group {
        margin-bottom: 18px;
        text-align: right;
    }

    .input-group label {
        display: block;
        margin-bottom: 10px;
        font-weight: 600;
        font-size: 0.95rem;
        color: var(--text-light);
        padding-right: 5px;
    }

    .dark-mode .input-group label {
        color: var(--text-dark);
    }

    .input-group label i {
        color: var(--primary);
        margin-left: 8px;
        font-size: 1rem;
    }

    .result-card {
        background: var(--card-light);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border: 1px solid var(--border-light);
        border-radius: 22px;
        padding: 24px;
        border-right: 6px solid var(--primary);
        box-shadow: 0 8px 20px rgba(0,0,0,0.03);
        text-align: right;
        transition: all 0.3s ease;
    }

    .dark-mode .result-card {
        background: var(--card-dark);
        border: 1px solid var(--border-dark);
        border-right: 6px solid var(--primary);
        box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }

    .result-card h3 {
        margin: 0 0 12px;
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--primary);
    }

    .result-card p {
        margin: 10px 0;
        font-size: 1rem;
        line-height: 1.6;
    }

    .result-card span {
        font-weight: 700;
        color: var(--primary);
    }

    .hidden { display: none; }

    #drawing-container {
        text-align: center;
        padding: 20px;
        background: var(--card-light);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border: 1px solid var(--border-light);
        border-radius: 22px;
        overflow: hidden;
    }

    .dark-mode #drawing-container {
        background: var(--card-dark);
        border: 1px solid var(--border-dark);
    }

    #shapeCanvas {
        max-width: 100%;
        height: auto;
        border-radius: 12px;
    }
</style>

<script>
    function calculateArea() {
        const a = parseFloat(document.getElementById("a").value);
        const b = parseFloat(document.getElementById("b").value);
        const L1 = parseFloat(document.getElementById("L1").value);
        const L2 = parseFloat(document.getElementById("L2").value);

        const initialAreaDiv = document.getElementById("initialArea");
        const drawingContainer = document.getElementById("drawing-container");
        const saveBtn = document.getElementById("saveBtn");

        if (isNaN(a) || isNaN(b) || isNaN(L1) || isNaN(L2) || a <= 0 || b <= 0 || L1 <= 0 || L2 <= 0) {
            initialAreaDiv.classList.add('hidden');
            drawingContainer.classList.add('hidden');
            saveBtn.style.display = 'none';
            return;
        }

        // حساب المساحة باستخدام صيغة براهماغوبتا
        const s = (a + b + L1 + L2) / 2;
        const area = Math.sqrt((s - a) * (s - b) * (s - L1) * (s - L2));

        if (isNaN(area) || area <= 0) {
            initialAreaDiv.innerHTML = `<p style="color: #e74c3c;">الأضلاع دي متنفعش تعمل رباعي دائري يا هندسة!</p>`;
            initialAreaDiv.classList.remove('hidden');
            drawingContainer.classList.add('hidden');
            saveBtn.style.display = 'none';
            return;
        }

        const areaConverted = convertToFeddans(area);
        const diagonals = calculateDiagonals(a, b, L1, L2);

        initialAreaDiv.innerHTML = `
            <h3>النتيجة:</h3>
            <p>المساحة الكلية: <span>${area.toFixed(2)}</span> متر²</p>
            <p>بالوحدات: <span>${areaConverted.feddan}</span> فدان، <span>${areaConverted.qirat}</span> قيراط، <span>${areaConverted.sahm}</span> سهم</p>
            <p>القطر الأول: <span>${diagonals.diagonal1.toFixed(2)}</span> متر</p>
            <p>القطر الثاني: <span>${diagonals.diagonal2.toFixed(2)}</span> متر</p>
        `;
        initialAreaDiv.classList.remove('hidden');
        drawingContainer.classList.remove('hidden');
        saveBtn.style.display = 'block';

        // رسم الرباعي الدائري
        drawCyclic(a, b, L1, L2, diagonals.diagonal1);
    }

    function drawCyclic(a, b, c, d, diag) {
        const canvas = document.getElementById('shapeCanvas');
        const ctx = canvas.getContext('2d');
        
        // تظبيط مقاس الكانفاس
        canvas.width = 800;
        canvas.height = 500;
        const padding = 60;
        const drawW = canvas.width - padding * 2;
        const drawH = canvas.height - padding * 2;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // حساب الإحداثيات باستخدام القطر الأول
        const cosAlpha = (a*a + diag*diag - b*b) / (2*a*diag);
        const alpha = Math.acos(cosAlpha);
        
        const cosBeta = (d*d + diag*diag - c*c) / (2*d*diag);
        const beta = Math.acos(cosBeta);

        let pt1 = { x: 0, y: 0 };
        let pt2 = { x: diag, y: 0 };
        let pt3 = { x: a * Math.cos(alpha), y: a * Math.sin(alpha) };
        let pt4 = { x: d * Math.cos(beta), y: -d * Math.sin(beta) };

        const pts = [pt1, pt2, pt3, pt4];
        const xs = pts.map(p => p.x);
        const ys = pts.map(p => p.y);
        const minX = Math.min(...xs);
        const maxX = Math.max(...xs);
        const minY = Math.min(...ys);
        const maxY = Math.max(...ys);

        const scale = Math.min(drawW / (maxX - minX), drawH / (maxY - minY));

        const offsetX = padding + (drawW - (maxX - minX) * scale) / 2 - minX * scale;
        const offsetY = padding + (drawH - (maxY - minY) * scale) / 2 - minY * scale;

        const sPts = pts.map(p => ({
            x: offsetX + p.x * scale,
            y: canvas.height - (offsetY + p.y * scale)
        }));

        const isDarkMode = document.documentElement.classList.contains('dark-mode');
        const textColor = isDarkMode ? '#ffffff' : '#1a1a1a';
        const strokeColor = isDarkMode ? '#4dabf7' : '#1971c2';
        const areaFillColor = isDarkMode ? 'rgba(77, 171, 247, 0.1)' : 'rgba(25, 113, 194, 0.05)';

        ctx.beginPath();
        ctx.moveTo(sPts[0].x, sPts[0].y);
        ctx.lineTo(sPts[2].x, sPts[2].y);
        ctx.lineTo(sPts[1].x, sPts[1].y);
        ctx.lineTo(sPts[3].x, sPts[3].y);
        ctx.closePath();

        ctx.fillStyle = areaFillColor;
        ctx.fill();
        ctx.strokeStyle = strokeColor;
        ctx.lineWidth = 4;
        ctx.lineJoin = 'round';
        ctx.stroke();

        // رسم الدائرة المارة بالرؤوس (اختياري بس بيدي شكل حلو للرباعي الدائري)
        // بنحسب مركز الدائرة المارة بمثلث واحد منهم (pt1, pt2, pt3)
        // دي معادلة معقدة شوية بس بتطلع نتيجة روعة
        const x1 = sPts[0].x, y1 = sPts[0].y;
        const x2 = sPts[1].x, y2 = sPts[1].y;
        const x3 = sPts[2].x, y3 = sPts[2].y;
        const D = 2 * (x1 * (y2 - y3) + x2 * (y3 - y1) + x3 * (y1 - y2));
        const centerX = ((x1*x1 + y1*y1) * (y2 - y3) + (x2*x2 + y2*y2) * (y3 - y1) + (x3*x3 + y3*y3) * (y1 - y2)) / D;
        const centerY = ((x1*x1 + y1*y1) * (x3 - x2) + (x2*x2 + y2*y2) * (x1 - x3) + (x3*x3 + y3*y3) * (x2 - x1)) / D;
        const radius = Math.sqrt((x1 - centerX)**2 + (y1 - centerY)**2);

        ctx.setLineDash([10, 10]);
        ctx.strokeStyle = isDarkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)';
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
        ctx.stroke();
        ctx.setLineDash([]);

        ctx.fillStyle = textColor;
        ctx.font = 'bold 15px Tajawal, Arial';
        ctx.textAlign = 'center';

        function drawLabel(pA, pB, label) {
            const midX = (pA.x + pB.x) / 2;
            const midY = (pA.y + pB.y) / 2;
            
            ctx.save();
            ctx.translate(midX, midY);
            const angle = Math.atan2(pB.y - pA.y, pB.x - pA.x);
            let labelAngle = angle;
            if (labelAngle > Math.PI/2 || labelAngle < -Math.PI/2) labelAngle += Math.PI;
            ctx.rotate(labelAngle);
            ctx.fillText(label, 0, -10);
            ctx.restore();
        }

        drawLabel(sPts[0], sPts[2], `a = ${a.toFixed(2)}`);
        drawLabel(sPts[2], sPts[1], `b = ${b.toFixed(2)}`);
        drawLabel(sPts[1], sPts[3], `c = ${c.toFixed(2)}`);
        drawLabel(sPts[3], sPts[0], `d = ${d.toFixed(2)}`);
    }

    // إضافة دعم السحب بالماوس للتمرير
    const scrollContainer = document.getElementById('canvasScroll');
    let isDown = false;
    let startX;
    let scrollLeft;

    if (scrollContainer) {
        scrollContainer.addEventListener('mousedown', (e) => {
            isDown = true;
            scrollContainer.classList.add('active');
            startX = e.pageX - scrollContainer.offsetLeft;
            scrollLeft = scrollContainer.scrollLeft;
        });
        scrollContainer.addEventListener('mouseleave', () => {
            isDown = false;
        });
        scrollContainer.addEventListener('mouseup', () => {
            isDown = false;
        });
        scrollContainer.addEventListener('mousemove', (e) => {
            if(!isDown) return;
            e.preventDefault();
            const x = e.pageX - scrollContainer.offsetLeft;
            const walk = (x - startX) * 2; 
            scrollContainer.scrollLeft = scrollLeft - walk;
        });
    }

    function calculateDiagonals(a, b, L1, L2) {
        const diagonal1 = Math.sqrt(((a * L1 + b * L2) * (a * L2 + b * L1)) / (a * b + L1 * L2));
        const diagonal2 = Math.sqrt(((a * L1 + b * L2) * (a * b + L1 * L2)) / (a * L2 + b * L1));
        return { diagonal1, diagonal2 };
    }

    function convertToFeddans(m2) {
        const feddan = 4200.83;
        const qirat = 175.034;
        const sahm = 7.293;

        let remaining = m2;
        let f = Math.floor(remaining / feddan);
        remaining -= f * feddan;
        let q = Math.floor(remaining / qirat);
        remaining -= q * qirat;
        let s = remaining / sahm;

        return { feddan: f, qirat: q, sahm: s.toFixed(2) };
    }

    function saveResult() {
        const a = document.getElementById("a").value;
        const b = document.getElementById("b").value;
        const L1 = document.getElementById("L1").value;
        const L2 = document.getElementById("L2").value;
        const resultText = document.getElementById("initialArea").innerText;
        
        const data = {
            type: "رباعي دائري",
            input: `أضلاع: ${a}, ${b}, ${L1}, ${L2}`,
            result: resultText,
            details: resultText
        };

        if (window.firebaseLogic && window.firebaseLogic.saveResult) {
            window.firebaseLogic.saveResult(data)
                .then(() => alert('تم حفظ النتيجة بنجاح يا ريس ✅'))
                .catch(() => alert('حصل مشكلة في السحابة، بس حفظناها محلياً'));
        } else {
            let savedResults = JSON.parse(localStorage.getItem('savedResults') || '[]');
            data.timestamp = new Date().toISOString();
            savedResults.push(data);
            localStorage.setItem('savedResults', JSON.stringify(savedResults));
            alert('تم الحفظ محلياً (Firebase غير متصل) ✅');
        }
    }
</script>