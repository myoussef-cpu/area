<title>حساب مساحة رباعي غير منتظم</title>

<div class="calc-container">
    <div class="card">
        <h4 style="margin-top: 0; color: var(--primary);">الأضلاع الأربعة:</h4>
        <div class="input-group">
            <label><i class="fas fa-arrows-alt-h"></i> الضلع الأول (a)</label>
            <input type="number" id="a" placeholder="أدخل الطول بالمتر" step="any" oninput="calculateAndDraw()">
        </div>
        <div class="input-group">
            <label><i class="fas fa-arrows-alt-h"></i> الضلع الثاني (b)</label>
            <input type="number" id="b" placeholder="أدخل الطول بالمتر" step="any" oninput="calculateAndDraw()">
        </div>
        <div class="input-group">
            <label><i class="fas fa-arrows-alt-v"></i> الضلع الثالث (c)</label>
            <input type="number" id="c" placeholder="أدخل الطول بالمتر" step="any" oninput="calculateAndDraw()">
        </div>
        <div class="input-group">
            <label><i class="fas fa-arrows-alt-v"></i> الضلع الرابع (d)</label>
            <input type="number" id="d" placeholder="أدخل الطول بالمتر" step="any" oninput="calculateAndDraw()">
        </div>

        <h4 style="margin-top: 20px; color: var(--primary);">الأقطار (مطلوب قطر واحد على الأقل):</h4>
        <div class="input-group">
            <label><i class="fas fa-slash"></i> القطر الأول (d1)</label>
            <input type="number" id="d1" placeholder="أدخل الطول بالمتر" step="any" oninput="calculateAndDraw()">
        </div>
        <div class="input-group">
            <label><i class="fas fa-slash"></i> القطر الثاني (d2)</label>
            <input type="number" id="d2" placeholder="أدخل الطول بالمتر" step="any" oninput="calculateAndDraw()">
        </div>
    </div>

    <div id="resultCard" class="result-card hidden">
        <h3>النتيجة:</h3>
        <p id="areaResult">المساحة: --</p>
        <p id="convertedUnits">الفدان: -- | القيراط: -- | السهم: --</p>
    </div>

    <div id="canvasCard" class="card hidden" style="text-align: center; overflow: hidden;">
        <canvas id="quadCanvas" width="300" height="300" style="max-width: 100%;"></canvas>
    </div>

    <button class="btn-main" onclick="saveResult()" id="saveBtn" style="display: none; margin-top: 10px; background: #27ae60;">
        <i class="fas fa-save"></i> حفظ النتيجة
    </button>
</div>

<style>
    .calc-container {
        display: flex;
        flex-direction: column;
        gap: 15px;
        padding-bottom: 20px;
    }

    .input-group {
        margin-bottom: 15px;
        text-align: right;
    }

    .input-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--text-light);
    }

    .dark-mode .input-group label {
        color: var(--text-dark);
    }

    .input-group label i {
        color: var(--primary);
        margin-left: 5px;
    }

    .result-card {
        background: white;
        border-radius: 16px;
        padding: 20px;
        border-right: 5px solid var(--primary);
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        text-align: right;
    }

    .dark-mode .result-card {
        background: var(--card-dark);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .result-card h3 {
        margin: 0 0 10px;
        font-size: 1.1rem;
        color: var(--primary);
    }

    .result-card p {
        margin: 8px 0;
        font-size: 0.95rem;
        line-height: 1.5;
    }

    .hidden { display: none; }
</style>

<script>
    function calculateAndDraw() {
        let a = parseFloat(document.getElementById("a").value);
        let b = parseFloat(document.getElementById("b").value);
        let c = parseFloat(document.getElementById("c").value);
        let d = parseFloat(document.getElementById("d").value);
        let d1 = parseFloat(document.getElementById("d1").value);
        let d2 = parseFloat(document.getElementById("d2").value);

        const resultCard = document.getElementById("resultCard");
        const canvasCard = document.getElementById("canvasCard");
        const saveBtn = document.getElementById("saveBtn");

        if (!a || !b || !c || !d) {
            resultCard.classList.add('hidden');
            canvasCard.classList.add('hidden');
            saveBtn.style.display = 'none';
            return;
        }

        let area;

        if (d1 && d2) {
            area = (d1 * d2) / 2; // تقريبي لو متعامدين، بس هنا للتوضيح
        } else if (d1 || d2) {
            let diagonal = d1 || d2;
            let s = (a + b + c + d) / 2;
            // معادلة بريتشنايدر (Bretschneider's formula) للرباعي العام
            // هنا بنفترض حالة خاصة للتبسيط لأن الزوايا مش معروفة
            // هنستخدم هيرون للمثلثين
            if (d1) {
                // مثلث 1: a, b, d1
                let s1 = (a + b + d1) / 2;
                let area1 = Math.sqrt(s1 * (s1 - a) * (s1 - b) * (s1 - d1));
                // مثلث 2: c, d, d1
                let s2 = (c + d + d1) / 2;
                let area2 = Math.sqrt(s2 * (s2 - c) * (s2 - d) * (s2 - d1));
                area = area1 + area2;
            } else {
                 // نفس المنطق للقطر التاني
                 // مثلث 1: a, d, d2
                 let s1 = (a + d + d2) / 2;
                 let area1 = Math.sqrt(s1 * (s1 - a) * (s1 - d) * (s1 - d2));
                 // مثلث 2: b, c, d2
                 let s2 = (b + c + d2) / 2;
                 let area2 = Math.sqrt(s2 * (s2 - b) * (s2 - c) * (s2 - d2));
                 area = area1 + area2;
            }
        } else {
            return; // لازم قطر واحد على الأقل
        }

        if (!isNaN(area) && area > 0) {
            let feddan = Math.floor(area / 4200.83);
            let remaining_after_feddan = area % 4200.83;
            let qirat = Math.floor(remaining_after_feddan / 175.034);
            let remaining_after_qirat = remaining_after_feddan % 175.034;
            let saham = (remaining_after_qirat / 7.293).toFixed(2);

            document.getElementById("areaResult").innerText = `المساحة: ${area.toFixed(2)} متر²`;
            document.getElementById("convertedUnits").innerHTML = `<span>${feddan}</span> فدان، <span>${qirat}</span> قيراط، <span>${saham}</span> سهم`;
            
            resultCard.classList.remove('hidden');
            canvasCard.classList.remove('hidden');
            saveBtn.style.display = 'block';

            drawQuadrilateral(a, b, c, d, d1, d2);
        } else {
            resultCard.classList.add('hidden');
            canvasCard.classList.add('hidden');
            saveBtn.style.display = 'none';
        }
    }

    function drawQuadrilateral(a, b, c, d, d1, d2) {
        let canvas = document.getElementById("quadCanvas");
        let ctx = canvas.getContext("2d");
        
        canvas.width = 400;
        canvas.height = 300;
        const padding = 40;
        const drawW = canvas.width - padding * 2;
        const drawH = canvas.height - padding * 2;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // هنستخدم القطر المتاح (d1 أو d2)
        let diag = d1 || d2;
        if (!diag) return;

        // حساب زوايا المثلثين باستخدام قانون جيب التمام
        // المثلث الأول: أضلاع a, b والقطر diag
        // الزاوية alpha هي الزاوية بين الضلع a والقطر diag
        const cosAlpha = (a*a + diag*diag - b*b) / (2*a*diag);
        
        // المثلث الثاني: أضلاع d, c والقطر diag
        // الزاوية beta هي الزاوية بين الضلع d والقطر diag
        const cosBeta = (d*d + diag*diag - c*c) / (2*d*diag);

        // لو الحسابات مش منطقية (مفيش مثلث ينفع يترسم بالأبعاد دي)
        if (Math.abs(cosAlpha) > 1 || Math.abs(cosBeta) > 1) {
            ctx.fillStyle = "#e74c3c";
            ctx.textAlign = "center";
            ctx.fillText("الأبعاد دي متعملش شكل رباعي يا هندسة", canvas.width/2, canvas.height/2);
            return;
        }

        const alpha = Math.acos(cosAlpha);
        const beta = Math.acos(cosBeta);

        // إحداثيات النقط
        // pt1 و pt2 هما طرفي القطر
        let pt1 = { x: 0, y: 0 };
        let pt2 = { x: diag, y: 0 };
        // pt3 فوق القطر (مثلث a, b, diag)
        let pt3 = { x: a * Math.cos(alpha), y: a * Math.sin(alpha) };
        // pt4 تحت القطر (مثلث d, c, diag)
        let pt4 = { x: d * Math.cos(beta), y: -d * Math.sin(beta) };

        // تظبيط المقاسات (Scaling)
        const pts = [pt1, pt2, pt3, pt4];
        const xs = pts.map(p => p.x);
        const ys = pts.map(p => p.y);
        const minX = Math.min(...xs);
        const maxX = Math.max(...xs);
        const minY = Math.min(...ys);
        const maxY = Math.max(...ys);

        const scaleX = drawW / (maxX - minX);
        const scaleY = drawH / (maxY - minY);
        const scale = Math.min(scaleX, scaleY);

        const offsetX = padding + (drawW - (maxX - minX) * scale) / 2 - minX * scale;
        const offsetY = padding + (drawH - (maxY - minY) * scale) / 2 - minY * scale;

        const sPts = pts.map(p => ({
            x: offsetX + p.x * scale,
            y: canvas.height - (offsetY + p.y * scale)
        }));

        // رسم الشكل الرباعي (التوصيل بين النقط بالترتيب)
        ctx.beginPath();
        ctx.moveTo(sPts[0].x, sPts[0].y); // نقطة البداية (طرف القطر)
        ctx.lineTo(sPts[2].x, sPts[2].y); // الضلع a
        ctx.lineTo(sPts[1].x, sPts[1].y); // الضلع b
        ctx.lineTo(sPts[3].x, sPts[3].y); // الضلع c
        ctx.closePath(); // الضلع d

        const isDarkMode = document.documentElement.classList.contains('dark-mode');
        
        ctx.strokeStyle = isDarkMode ? '#4dabf7' : '#3498db';
        ctx.lineWidth = 3;
        ctx.stroke();
        ctx.fillStyle = isDarkMode ? 'rgba(77, 171, 247, 0.1)' : 'rgba(52, 152, 219, 0.1)';
        ctx.fill();

        // رسم القطر كخط منقط
        ctx.setLineDash([5, 5]);
        ctx.beginPath();
        ctx.moveTo(sPts[0].x, sPts[0].y);
        ctx.lineTo(sPts[1].x, sPts[1].y);
        ctx.strokeStyle = isDarkMode ? '#8e8e93' : '#95a5a6';
        ctx.stroke();
        ctx.setLineDash([]);

        // إضافة أطوال الأضلاع
        ctx.fillStyle = isDarkMode ? '#e0e0e0' : '#2c3e50';
        ctx.font = 'bold 13px Arial';
        ctx.textAlign = 'center';

        function drawLabel(pA, pB, label) {
            const midX = (pA.x + pB.x) / 2;
            const midY = (pA.y + pB.y) / 2;
            ctx.fillText(label + ' م', midX, midY - 5);
        }

        drawLabel(sPts[0], sPts[2], a.toFixed(1)); // الضلع a
        drawLabel(sPts[2], sPts[1], b.toFixed(1)); // الضلع b
        drawLabel(sPts[1], sPts[3], c.toFixed(1)); // الضلع c
        drawLabel(sPts[3], sPts[0], d.toFixed(1)); // الضلع d
        
        // القطر
        ctx.font = '11px Arial';
        ctx.fillText(`${diag.toFixed(1)} م (قطر)`, (sPts[0].x + sPts[1].x) / 2, (sPts[0].y + sPts[1].y) / 2 + 15);
    }

    function saveResult() {
        const areaText = document.getElementById("areaResult").innerText;
        const unitsText = document.getElementById("convertedUnits").innerText;
        
        const data = {
            type: "رباعي غير منتظم",
            result: areaText,
            details: unitsText
        };

        if (window.firebaseLogic && window.firebaseLogic.saveResult) {
            window.firebaseLogic.saveResult(data)
                .then(() => alert('تم حفظ النتيجة بنجاح يا ريس ✅'))
                .catch(() => alert('حصل مشكلة في السحابة، بس حفظناها محلياً'));
        } else {
            let savedResults = JSON.parse(localStorage.getItem('savedResults') || '[]');
            data.timestamp = new Date().toISOString();
            savedResults.push(data);
            localStorage.setItem('savedResults', JSON.stringify(savedResults));
            alert('تم الحفظ محلياً (Firebase غير متصل) ✅');
        }
    }
</script>