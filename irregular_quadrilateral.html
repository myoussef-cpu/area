<title>حساب مساحة رباعي غير منتظم</title>

<div class="calc-container">
    <div class="card">
        <h4 style="margin-top: 0; color: var(--primary);">الأضلاع الأربعة:</h4>
        <div class="input-group">
            <label><i class="fas fa-arrows-alt-h"></i> الضلع الأول (a)</label>
            <input type="number" id="a" placeholder="أدخل الطول بالمتر" step="any" oninput="calculateAndDraw()">
        </div>
        <div class="input-group">
            <label><i class="fas fa-arrows-alt-h"></i> الضلع الثاني (b)</label>
            <input type="number" id="b" placeholder="أدخل الطول بالمتر" step="any" oninput="calculateAndDraw()">
        </div>
        <div class="input-group">
            <label><i class="fas fa-arrows-alt-v"></i> الضلع الثالث (c)</label>
            <input type="number" id="c" placeholder="أدخل الطول بالمتر" step="any" oninput="calculateAndDraw()">
        </div>
        <div class="input-group">
            <label><i class="fas fa-arrows-alt-v"></i> الضلع الرابع (d)</label>
            <input type="number" id="d" placeholder="أدخل الطول بالمتر" step="any" oninput="calculateAndDraw()">
        </div>

        <h4 style="margin-top: 20px; color: var(--primary);">الأقطار (مطلوب قطر واحد على الأقل):</h4>
        <div class="input-group">
            <label><i class="fas fa-slash"></i> القطر الأول (d1)</label>
            <input type="number" id="d1" placeholder="أدخل الطول بالمتر" step="any" oninput="calculateAndDraw()">
        </div>
        <div class="input-group">
            <label><i class="fas fa-slash"></i> القطر الثاني (d2)</label>
            <input type="number" id="d2" placeholder="أدخل الطول بالمتر" step="any" oninput="calculateAndDraw()">
        </div>
    </div>

    <div id="resultCard" class="result-card hidden">
        <h3>النتيجة:</h3>
        <p id="areaResult">المساحة: --</p>
        <p id="convertedUnits">الفدان: -- | القيراط: -- | السهم: --</p>
    </div>

    <div id="canvasCard" class="card hidden" style="text-align: center; overflow: hidden;">
        <canvas id="quadCanvas" width="300" height="300" style="max-width: 100%;"></canvas>
    </div>

    <button class="btn-main" onclick="saveResult()" id="saveBtn" style="display: none; margin-top: 10px; background: #27ae60;">
        <i class="fas fa-save"></i> حفظ النتيجة
    </button>
</div>

<style>
    .calc-container {
        display: flex;
        flex-direction: column;
        gap: 15px;
        padding-bottom: 20px;
    }

    .input-group {
        margin-bottom: 15px;
        text-align: right;
    }

    .input-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--text-light);
    }

    .dark-mode .input-group label {
        color: var(--text-dark);
    }

    .input-group label i {
        color: var(--primary);
        margin-left: 5px;
    }

    .result-card {
        background: white;
        border-radius: 16px;
        padding: 20px;
        border-right: 5px solid var(--primary);
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        text-align: right;
    }

    .dark-mode .result-card {
        background: var(--card-dark);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .result-card h3 {
        margin: 0 0 10px;
        font-size: 1.1rem;
        color: var(--primary);
    }

    .result-card p {
        margin: 8px 0;
        font-size: 0.95rem;
        line-height: 1.5;
    }

    .hidden { display: none; }
</style>

<script>
    function calculateAndDraw() {
        let a = parseFloat(document.getElementById("a").value);
        let b = parseFloat(document.getElementById("b").value);
        let c = parseFloat(document.getElementById("c").value);
        let d = parseFloat(document.getElementById("d").value);
        let d1 = parseFloat(document.getElementById("d1").value);
        let d2 = parseFloat(document.getElementById("d2").value);

        const resultCard = document.getElementById("resultCard");
        const canvasCard = document.getElementById("canvasCard");
        const saveBtn = document.getElementById("saveBtn");

        if (!a || !b || !c || !d) {
            resultCard.classList.add('hidden');
            canvasCard.classList.add('hidden');
            saveBtn.style.display = 'none';
            return;
        }

        let area;

        if (d1 && d2) {
            area = (d1 * d2) / 2; // تقريبي لو متعامدين، بس هنا للتوضيح
        } else if (d1 || d2) {
            let diagonal = d1 || d2;
            let s = (a + b + c + d) / 2;
            // معادلة بريتشنايدر (Bretschneider's formula) للرباعي العام
            // هنا بنفترض حالة خاصة للتبسيط لأن الزوايا مش معروفة
            // هنستخدم هيرون للمثلثين
            if (d1) {
                // مثلث 1: a, b, d1
                let s1 = (a + b + d1) / 2;
                let area1 = Math.sqrt(s1 * (s1 - a) * (s1 - b) * (s1 - d1));
                // مثلث 2: c, d, d1
                let s2 = (c + d + d1) / 2;
                let area2 = Math.sqrt(s2 * (s2 - c) * (s2 - d) * (s2 - d1));
                area = area1 + area2;
            } else {
                 // نفس المنطق للقطر التاني
                 // مثلث 1: a, d, d2
                 let s1 = (a + d + d2) / 2;
                 let area1 = Math.sqrt(s1 * (s1 - a) * (s1 - d) * (s1 - d2));
                 // مثلث 2: b, c, d2
                 let s2 = (b + c + d2) / 2;
                 let area2 = Math.sqrt(s2 * (s2 - b) * (s2 - c) * (s2 - d2));
                 area = area1 + area2;
            }
        } else {
            return; // لازم قطر واحد على الأقل
        }

        if (!isNaN(area) && area > 0) {
            let feddan = Math.floor(area / 4200.83);
            let remaining_after_feddan = area % 4200.83;
            let qirat = Math.floor(remaining_after_feddan / 175.034);
            let remaining_after_qirat = remaining_after_feddan % 175.034;
            let saham = (remaining_after_qirat / 7.293).toFixed(2);

            document.getElementById("areaResult").innerText = `المساحة: ${area.toFixed(2)} متر²`;
            document.getElementById("convertedUnits").innerHTML = `<span>${feddan}</span> فدان، <span>${qirat}</span> قيراط، <span>${saham}</span> سهم`;
            
            resultCard.classList.remove('hidden');
            canvasCard.classList.remove('hidden');
            saveBtn.style.display = 'block';

            drawQuadrilateral(a, b, c, d, d1, d2);
        } else {
            resultCard.classList.add('hidden');
            canvasCard.classList.add('hidden');
            saveBtn.style.display = 'none';
        }
    }

    function drawQuadrilateral(a, b, c, d, d1, d2) {
        let canvas = document.getElementById("quadCanvas");
        let ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // رسم تخيلي بسيط للتوضيح فقط لأن الإحداثيات الحقيقية محتاجة زوايا
        let maxSide = Math.max(a, b, c, d, d1 || 0, d2 || 0);
        let scale = 200 / maxSide; 
        let cx = canvas.width / 2;
        let cy = canvas.height / 2;

        ctx.beginPath();
        ctx.moveTo(cx - 50, cy - 50);
        ctx.lineTo(cx + 50, cy - 50);
        ctx.lineTo(cx + 70, cy + 50);
        ctx.lineTo(cx - 70, cy + 50);
        ctx.closePath();
        ctx.strokeStyle = "#007bff";
        ctx.lineWidth = 2;
        ctx.stroke();
        
        ctx.fillStyle = "#333";
        ctx.font = "12px Arial";
        ctx.fillText("رسم توضيحي", cx - 30, cy);
    }

    function saveResult() {
        const areaText = document.getElementById("areaResult").innerText;
        const unitsText = document.getElementById("convertedUnits").innerText;
        
        const data = {
            type: "رباعي غير منتظم",
            result: areaText,
            details: unitsText
        };

        if (window.firebaseLogic && window.firebaseLogic.saveResult) {
            window.firebaseLogic.saveResult(data)
                .then(() => alert('تم حفظ النتيجة بنجاح يا ريس ✅'))
                .catch(() => alert('حصل مشكلة في السحابة، بس حفظناها محلياً'));
        } else {
            let savedResults = JSON.parse(localStorage.getItem('savedResults') || '[]');
            data.timestamp = new Date().toISOString();
            savedResults.push(data);
            localStorage.setItem('savedResults', JSON.stringify(savedResults));
            alert('تم الحفظ محلياً (Firebase غير متصل) ✅');
        }
    }
</script>